# Coding Agent Harness - Docker Compose
# ======================================
#
# Usage:
#   # With bundled PostgreSQL (recommended for development)
#   docker-compose --profile with-db up
#
#   # With external database (Supabase, Neon, Railway, etc.)
#   # First set DATABASE_URL in .env
#   docker-compose --profile external-db up
#
# Environment Variables (see .env.example):
#   - CLAUDE_CODE_OAUTH_TOKEN: Claude Code OAuth token (required)
#   - LINEAR_API_KEY: Linear API key (optional, for Linear backend)
#   - DATABASE_URL: PostgreSQL connection URL (required for external-db profile)
#   - API_PORT: Port for API server (default: 8080)
#   - WORKSPACE_PATH: Path to workspace directory (default: ./workspaces)

version: "3.8"

services:
  # ============================================
  # EXTERNAL DATABASE (Supabase, Neon, etc.)
  # Command: docker-compose --profile external-db up
  # ============================================
  coding-agent-harness:
    profiles: ["external-db"]
    build:
      context: .
      dockerfile: Dockerfile
    container_name: harness_app
    env_file: .env
    environment:
      # These can be overridden in .env
      PYTHONUNBUFFERED: "1"
    ports:
      - "${API_PORT:-8080}:8080"
    volumes:
      - ${WORKSPACE_PATH:-./workspaces}:/workspaces
      # Mount prompts for customization
      - ./prompts:/app/prompts:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # BUNDLED POSTGRESQL
  # Command: docker-compose --profile with-db up
  # ============================================
  coding-agent-harness-with-db:
    profiles: ["with-db"]
    build:
      context: .
      dockerfile: Dockerfile
    container_name: harness_app
    env_file: .env
    environment:
      # Override DATABASE_URL to use Docker service name
      DATABASE_URL: postgresql://postgres:postgres@postgres:5433/coding_agent_harness_db
      PYTHONUNBUFFERED: "1"
    ports:
      - "${API_PORT:-8080}:8080"
    volumes:
      - ${WORKSPACE_PATH:-./workspaces}:/workspaces
      # Mount prompts for customization
      - ./prompts:/app/prompts:ro
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  postgres:
    profiles: ["with-db"]
    image: postgres:18-alpine
    container_name: harness_db
    environment:
      POSTGRES_DB: coding_agent_harness_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      PGPORT: "5433"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Initialize database schema on first run
      - ./database/migrations:/docker-entrypoint-initdb.d:ro
    ports:
      - "${POSTGRES_PORT:-5433}:5433"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d coding_agent_harness_db -p 5433"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ============================================
  # DEVELOPMENT DATABASE ONLY
  # Command: docker-compose --profile dev-db up postgres-dev
  # ============================================
  postgres-dev:
    profiles: ["dev-db"]
    image: postgres:18-alpine
    container_name: harness_db_dev
    environment:
      POSTGRES_DB: coding_agent_harness_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
      - ./database/migrations:/docker-entrypoint-initdb.d:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d coding_agent_harness_db"]
      interval: 5s
      timeout: 5s
      retries: 5

volumes:
  postgres_data:
    name: coding-agent-harness-data
  postgres_dev_data:
    name: coding-agent-harness-dev-data
